<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>VIN Decoder (Add & Customize Fields)</title>
  <style>
    /* Centering headings and main text */
    h1, h2 {
      text-align: center;
    }
    .instructions {
      text-align: center;
      margin-bottom: 1em;
    }

    /* Centering buttons and giving them some color/styling */
    .button-row {
      text-align: center;
      margin-bottom: 1em;
    }
    button {
      background-color: #007BFF; /* A blue color */
      color: #fff;
      border: none;
      padding: 8px 16px;
      margin: 4px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
    }
    button:hover {
      background-color: #0056b3; /* Darker on hover */
    }

    /* Results Container */
    #resultsContainer > .vin-block {
      border: 1px solid #ccc;
      padding: 8px;
      margin-bottom: 8px;
    }
    #resultsContainer h3 {
      margin-top: 0;
    }

    /* Modal Overlay */
    #modalOverlay {
      position: fixed; 
      top: 0; 
      left: 0; 
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      display: none; 
      justify-content: center; 
      align-items: center;
      z-index: 9999;
    }

    /* Modal Window */
    #modal {
      background: #fff;
      padding: 20px;
      width: 550px;
      max-width: 95%;
      box-shadow: 0 2px 10px rgba(0,0,0,0.3);
      max-height: 90%;
      overflow-y: auto;
      position: relative;
    }

    /* Close Button (X) */
    .close-modal {
      position: absolute;
      top: 8px;
      right: 8px;
      background: none;
      border: none;
      font-size: 18px;
      cursor: pointer;
    }

    /* Field Lists */
    .field-group {
      border: 1px solid #ddd;
      padding: 0;
      margin: 10px 0;
      min-height: 40px; /* so an empty list is still visible */
    }
    .field-group h4 {
      margin: 0;
      background: #f5f5f5;
      padding: 8px;
    }

    .field-list-item {
      list-style: none;
      border-bottom: 1px solid #eee;
      padding: 6px;
      display: flex;
      align-items: center;
      justify-content: space-between;

      background-color: #fff;
    }
    .field-list-item.drag-over {
      border: 1px dashed #666;
      background-color: #f0f0f0;
    }
    .field-label {
      flex-grow: 1;
      margin-left: 8px;
    }

    /* Add-field form */
    .add-field-form {
      border: 1px solid #ccc;
      padding: 10px;
      margin: 10px 0;
    }
    .add-field-form input {
      margin-bottom: 6px;
      display: block;
      width: 100%;
      box-sizing: border-box;
    }

    .modal-actions {
      margin-top: 10px;
      text-align: center;
    }
  </style>
</head>
<body>
  <h1>VIN Decoder (Add & Customize Fields)</h1>
  <div class="instructions">
    Paste your VINs (one per line) below, then click "Decode VINs".
  </div>

  <!-- Button Row -->
  <div class="button-row">
    <textarea id="vinInput" rows="8" placeholder="Paste VINs here, one per line"></textarea>
    <br />
    <button id="decodeBtn">Decode VINs</button>
    <button id="clearBtn">Clear</button>
    <button id="customizeBtn">Customize Fields</button>
  </div>

  <h2>Decoded Results</h2>
  <!-- We'll place the "Copy ALL VIN Data" button here -->
  <div id="copyAllContainer" class="button-row"></div>

  <div id="resultsContainer"></div>
  
  <!-- Modal Overlay for Customize Fields -->
  <div id="modalOverlay">
    <div id="modal">
      <button class="close-modal" title="Close" id="closeModalBtn">✕</button>
      <h3>Customize Fields & Order</h3>
      <p>Checked fields appear on top; unchecked fields appear below.</p>
      <p>Drag and drop within each group to reorder. Toggle the checkbox to move fields between groups.</p>

      <!-- Checked Fields Group -->
      <div class="field-group">
        <h4>Enabled Fields (drag to reorder)</h4>
        <ul id="checkedFieldsList"></ul>
      </div>

      <!-- Unchecked Fields Group -->
      <div class="field-group">
        <h4>Disabled Fields (drag to reorder)</h4>
        <ul id="uncheckedFieldsList"></ul>
      </div>

      <!-- Add new field form -->
      <div class="add-field-form">
        <h4>Add New Field</h4>
        <input type="text" id="addFieldId" placeholder="Numeric ID (optional)" />
        <input type="text" id="addFieldLabel" placeholder="Field Label" />
        <input type="text" id="addFieldProperty" placeholder="Property Name in NHTSA JSON" />
        <button id="addFieldBtn">Add Field</button>
      </div>

      <div class="modal-actions">
        <button id="saveCustomFieldsBtn">Save</button>
        <button id="resetDefaultFieldsBtn">Restore Default Fields</button>
      </div>
    </div>
  </div>

  <script>
    // ---------------------------------------------------------------------
    // 1) MASTER LIST OF KNOWN FIELDS (demo subset).
    // ---------------------------------------------------------------------
    const masterFieldsList = [
      { numericId: 29,  label: 'Model Year',   propertyName: 'ModelYear',   enabled: false },
      { numericId: 26,  label: 'Make',         propertyName: 'Make',        enabled: false },
      { numericId: 28,  label: 'Model',        propertyName: 'Model',       enabled: false },
      { numericId: 64,  label: 'Engine Configuration', propertyName: 'EngineConfiguration', enabled: false },
      // ... (Add the rest of your fields below) ...
    ];

    // IDs that should be enabled by default (first load)
    const DEFAULT_ENABLED_IDS = [29, 26, 28]; // e.g., Model Year, Make, Model

    // Current config of fields (loaded from localStorage or from master list)
    let currentFieldsList = [];

    // Elements
    const vinInput = document.getElementById('vinInput');
    const decodeBtn = document.getElementById('decodeBtn');
    const clearBtn = document.getElementById('clearBtn');
    const resultsContainer = document.getElementById('resultsContainer');
    const customizeBtn = document.getElementById('customizeBtn');
    const modalOverlay = document.getElementById('modalOverlay');
    const closeModalBtn = document.getElementById('closeModalBtn');
    const checkedFieldsListEl = document.getElementById('checkedFieldsList');
    const uncheckedFieldsListEl = document.getElementById('uncheckedFieldsList');
    const saveCustomFieldsBtn = document.getElementById('saveCustomFieldsBtn');
    const resetDefaultFieldsBtn = document.getElementById('resetDefaultFieldsBtn');
    const addFieldId = document.getElementById('addFieldId');
    const addFieldLabel = document.getElementById('addFieldLabel');
    const addFieldProperty = document.getElementById('addFieldProperty');
    const addFieldBtn = document.getElementById('addFieldBtn');
    const copyAllContainer = document.getElementById('copyAllContainer');

    // --------------------------------------------
    // 2) LOAD/SAVE FIELD CONFIG FROM LOCALSTORAGE
    // --------------------------------------------
    function loadFieldConfig() {
      const saved = localStorage.getItem('vinDecoderFields');
      if (saved) {
        currentFieldsList = JSON.parse(saved);
      } else {
        // No saved config; copy from master, enabling certain defaults
        currentFieldsList = masterFieldsList.map(field => ({
          ...field,
          enabled: DEFAULT_ENABLED_IDS.includes(field.numericId)
        }));
      }
    }
    function saveFieldConfig() {
      localStorage.setItem('vinDecoderFields', JSON.stringify(currentFieldsList));
    }
    loadFieldConfig(); // initialize

    // ------------------------------------------------------
    // 3) SHOW/HIDE MODAL
    // ------------------------------------------------------
    function openModal() {
      buildFieldLists();
      modalOverlay.style.display = 'flex';
    }
    function closeModal() {
      modalOverlay.style.display = 'none';
    }
    customizeBtn.addEventListener('click', openModal);
    closeModalBtn.addEventListener('click', () => {
      // If user cancels, reload from storage to discard changes
      loadFieldConfig();
      closeModal();
    });

    // ------------------------------------------------------
    // 4) BUILD THE CHECKED/UNCHECKED FIELD LISTS (DRAG & DROP)
    // ------------------------------------------------------
    function buildFieldLists() {
      // Separate fields into checked and unchecked arrays
      const checked = currentFieldsList.filter(f => f.enabled);
      const unchecked = currentFieldsList.filter(f => !f.enabled);

      // Clear the UI
      checkedFieldsListEl.innerHTML = '';
      uncheckedFieldsListEl.innerHTML = '';

      // Build the UI for each group
      buildDragList(checked, checkedFieldsListEl, true);
      buildDragList(unchecked, uncheckedFieldsListEl, false);
    }

    // Helper to build a drag&drop list for a given array of fields
    function buildDragList(fieldsArray, containerEl, isCheckedGroup) {
      fieldsArray.forEach((field, index) => {
        const li = document.createElement('li');
        li.className = 'field-list-item';
        li.draggable = true;
        li.dataset.index = index.toString();
        li.dataset.isChecked = isCheckedGroup ? 'true' : 'false';

        // Drag events
        li.addEventListener('dragstart', onDragStart);
        li.addEventListener('dragover', onDragOver);
        li.addEventListener('drop', onDrop);
        li.addEventListener('dragend', onDragEnd);

        // Checkbox
        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.checked = isCheckedGroup;
        checkbox.addEventListener('change', () => {
          field.enabled = checkbox.checked;
          // Rebuild the lists so the field moves to other group
          buildFieldLists();
        });

        // Label
        const labelSpan = document.createElement('span');
        labelSpan.className = 'field-label';
        labelSpan.textContent = `${field.label} (${field.numericId || 'N/A'})`;

        li.appendChild(checkbox);
        li.appendChild(labelSpan);
        containerEl.appendChild(li);
      });
    }

    // Drag & Drop Implementation
    let dragSrcEl = null;
    let dragSrcIndex = null;
    let dragSrcIsChecked = null;

    function onDragStart(e) {
      dragSrcEl = this;
      dragSrcIndex = parseInt(this.dataset.index, 10);
      dragSrcIsChecked = (this.dataset.isChecked === 'true');
      e.dataTransfer.effectAllowed = 'move';
      e.dataTransfer.setData('text/html', this.innerHTML);
    }
    function onDragOver(e) {
      e.preventDefault();
      this.classList.add('drag-over');
      e.dataTransfer.dropEffect = 'move';
    }
    function onDragEnd() {
      const items = document.querySelectorAll('.field-list-item');
      items.forEach(i => i.classList.remove('drag-over'));
    }
    function onDrop(e) {
      e.stopPropagation();
      const dropTarget = this;
      dropTarget.classList.remove('drag-over');
      if (dragSrcEl === dropTarget) {
        return;
      }
      const dropIndex = parseInt(dropTarget.dataset.index, 10);
      const dropIsChecked = (dropTarget.dataset.isChecked === 'true');

      const checkedArray = currentFieldsList.filter(f => f.enabled);
      const uncheckedArray = currentFieldsList.filter(f => !f.enabled);

      // Remove dragged item from its array
      let item;
      if (dragSrcIsChecked) {
        item = checkedArray.splice(dragSrcIndex, 1)[0];
      } else {
        item = uncheckedArray.splice(dragSrcIndex, 1)[0];
      }

      // If same group, reorder
      if (dragSrcIsChecked === dropIsChecked) {
        if (dropIsChecked) {
          checkedArray.splice(dropIndex, 0, item);
        } else {
          uncheckedArray.splice(dropIndex, 0, item);
        }
      } else {
        // cross-group drag not allowed; revert
        if (dragSrcIsChecked) {
          checkedArray.splice(dragSrcIndex, 0, item);
        } else {
          uncheckedArray.splice(dragSrcIndex, 0, item);
        }
      }

      // Rebuild currentFieldsList
      currentFieldsList = [...checkedArray, ...uncheckedArray];
      buildFieldLists();
    }

    // -----------------------------------------------------------
    // 5) ADD NEW FIELD
    // -----------------------------------------------------------
    addFieldBtn.addEventListener('click', () => {
      const numId = parseInt(addFieldId.value.trim(), 10) || null;
      const label = addFieldLabel.value.trim();
      const prop = addFieldProperty.value.trim();

      if (!label || !prop) {
        alert('Please provide at least a Label and a Property Name.');
        return;
      }

      const newField = {
        numericId: numId,
        label,
        propertyName: prop,
        enabled: true // new fields default to enabled
      };

      currentFieldsList.push(newField);
      buildFieldLists();

      // Clear form
      addFieldId.value = '';
      addFieldLabel.value = '';
      addFieldProperty.value = '';
    });

    // -----------------------------------------------------------
    // 6) SAVE OR RESET DEFAULT FIELDS
    // -----------------------------------------------------------
    saveCustomFieldsBtn.addEventListener('click', () => {
      // Save changes
      saveFieldConfig();
      closeModal();
    });

    resetDefaultFieldsBtn.addEventListener('click', () => {
      // Re-derive from master list with default IDs
      currentFieldsList = masterFieldsList.map(field => ({
        ...field,
        enabled: DEFAULT_ENABLED_IDS.includes(field.numericId)
      }));
      buildFieldLists();
    });

    // -----------------------------------------------------------
    // 7) DECODING LOGIC + "COPY ALL" BUTTON
    // -----------------------------------------------------------
    decodeBtn.addEventListener('click', async () => {
      const vinList = vinInput.value
        .split(/\n/g)
        .map(v => v.trim())
        .filter(v => v !== '');
      
      if (!vinList.length) {
        alert('No VINs entered!');
        return;
      }

      // Clear old results
      resultsContainer.innerHTML = '';
      copyAllContainer.innerHTML = '';

      const batchString = vinList.join(';');

      try {
        const response = await fetch('https://vpic.nhtsa.dot.gov/api/vehicles/DecodeVINValuesBatch/', {
          method: 'POST',
          headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
          body: new URLSearchParams({
            format: 'json',
            data: batchString
          })
        });
        
        const data = await response.json();
        const results = data.Results || [];

        if (results.length > 0) {
          // "Copy ALL" button at the top
          const copyAllBtn = document.createElement('button');
          copyAllBtn.textContent = 'Copy ALL VIN Data';
          copyAllBtn.addEventListener('click', () => {
            const lines = results.map(item => getRowData(item));
            const finalString = lines.join('\n');
            navigator.clipboard.writeText(finalString)
              .then(() => alert('Copied all VIN data to clipboard!'))
              .catch(() => alert('Unable to copy.'));
          });
          copyAllContainer.appendChild(copyAllBtn);
        }

        // Build each VIN result block
        results.forEach((decodedItem, idx) => {
          const vinDiv = document.createElement('div');
          vinDiv.className = 'vin-block';
          
          const vinHeader = document.createElement('h3');
          vinHeader.innerText = `#${idx + 1} VIN: ${decodedItem.VIN || 'null'}`;
          vinDiv.appendChild(vinHeader);

          // "Copy This VIN" button
          const copyBtn = document.createElement('button');
          copyBtn.innerText = 'Copy This VIN Data';
          copyBtn.style.marginBottom = '8px';
          copyBtn.addEventListener('click', () => {
            const rowData = getRowData(decodedItem);
            navigator.clipboard.writeText(rowData)
              .then(() => alert(`Copied data for VIN: ${decodedItem.VIN}`))
              .catch(() => alert('Unable to copy.'));
          });
          vinDiv.appendChild(copyBtn);

          // List of field values
          const dataList = document.createElement('ul');

          // Only iterate enabled fields, in the current order
          const enabledFields = currentFieldsList.filter(f => f.enabled);
          enabledFields.forEach(f => {
            const li = document.createElement('li');
            // If field is blank, display "null"
            const value = decodedItem[f.propertyName] || 'null';
            li.textContent = `${f.label}: ${value}`;
            dataList.appendChild(li);
          });
          
          vinDiv.appendChild(dataList);
          resultsContainer.appendChild(vinDiv);
        });

      } catch (err) {
        console.error(err);
        alert('Error decoding VINs. See console for details.');
      }
    });

    // Return a single tab-separated line for one VIN’s data
    function getRowData(decodedItem) {
      const enabledFields = currentFieldsList.filter(f => f.enabled);
      const values = enabledFields.map(f => {
        // If the API value is blank, use 'null'
        return decodedItem[f.propertyName] || 'null';
      });
      return values.join('\t');
    }

    // Clear / Reset
    clearBtn.addEventListener('click', () => {
      vinInput.value = '';
      resultsContainer.innerHTML = '';
      copyAllContainer.innerHTML = '';
    });
  </script>
</body>
</html>
