<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>VIN Decoder (Add & Customize Fields)</title>
  <style>
    /* Centering headings and main text */
    h1, h2 {
      text-align: center;
    }
    .instructions {
      text-align: center;
      margin-bottom: 1em;
    }

    /* Centering buttons and giving them some color/styling */
    .button-row {
      text-align: center;
      margin-bottom: 1em;
    }
    button {
      background-color: #007BFF; /* A blue color */
      color: #fff;
      border: none;
      padding: 8px 16px;
      margin: 4px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
    }
    button:hover {
      background-color: #0056b3; /* Darker on hover */
    }

    /* Results Container */
    #resultsContainer > .vin-block {
      border: 1px solid #ccc;
      padding: 8px;
      margin-bottom: 8px;
    }
    #resultsContainer h3 {
      margin-top: 0;
    }

    /* Modal Overlay */
    #modalOverlay {
      position: fixed; 
      top: 0; 
      left: 0; 
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      display: none; 
      justify-content: center; 
      align-items: center;
      z-index: 9999;
    }

    /* Modal Window */
    #modal {
      background: #fff;
      padding: 20px;
      width: 550px;
      max-width: 95%;
      box-shadow: 0 2px 10px rgba(0,0,0,0.3);
      max-height: 90%;
      overflow-y: auto;
      position: relative;
    }

    /* Close Button (X) */
    .close-modal {
      position: absolute;
      top: 8px;
      right: 8px;
      background: none;
      border: none;
      font-size: 18px;
      cursor: pointer;
    }

    /* Field Lists */
    .field-group {
      border: 1px solid #ddd;
      padding: 0;
      margin: 10px 0;
      min-height: 40px; /* so an empty list is still visible */
    }
    .field-group h4 {
      margin: 0;
      background: #f5f5f5;
      padding: 8px;
    }

    .field-list-item {
      list-style: none;
      border-bottom: 1px solid #eee;
      padding: 6px;
      display: flex;
      align-items: center;
      justify-content: space-between;

      background-color: #fff;
    }
    .field-list-item.drag-over {
      border: 1px dashed #666;
      background-color: #f0f0f0;
    }
    .field-label {
      flex-grow: 1;
      margin-left: 8px;
    }

    /* Add-field form */
    .add-field-form {
      border: 1px solid #ccc;
      padding: 10px;
      margin: 10px 0;
    }
    .add-field-form input {
      margin-bottom: 6px;
      display: block;
      width: 100%;
      box-sizing: border-box;
    }

    .modal-actions {
      margin-top: 10px;
      text-align: center;
    }
  </style>
</head>
<body>
  <h1>VIN Decoder (Add & Customize Fields)</h1>
  <div class="instructions">
    Paste your VINs (one per line) below, then click "Decode VINs".
  </div>

  <!-- Button Row -->
  <div class="button-row">
    <textarea id="vinInput" rows="8" placeholder="Paste VINs here, one per line"></textarea>
    <br />
    <button id="decodeBtn">Decode VINs</button>
    <button id="clearBtn">Clear</button>
    <button id="customizeBtn">Customize Fields</button>
  </div>

  <h2>Decoded Results</h2>
  <!-- We'll place the "Copy ALL VIN Data" button here -->
  <div id="copyAllContainer" class="button-row"></div>

  <div id="resultsContainer"></div>
  
  <!-- Modal Overlay for Customize Fields -->
  <div id="modalOverlay">
    <div id="modal">
      <button class="close-modal" title="Close" id="closeModalBtn">✕</button>
      <h3>Customize Fields & Order</h3>
      <p>Checked fields appear on top; unchecked fields appear below.</p>
      <p>Drag and drop within each group to reorder. Toggle the checkbox to move fields between groups.</p>

      <!-- Checked Fields Group -->
      <div class="field-group">
        <h4>Enabled Fields (drag to reorder)</h4>
        <ul id="checkedFieldsList"></ul>
      </div>

      <!-- Unchecked Fields Group -->
      <div class="field-group">
        <h4>Disabled Fields (drag to reorder)</h4>
        <ul id="uncheckedFieldsList"></ul>
      </div>

      <!-- Add new field form -->
      <div class="add-field-form">
        <h4>Add New Field</h4>
        <input type="text" id="addFieldId" placeholder="Numeric ID (optional)" />
        <input type="text" id="addFieldLabel" placeholder="Field Label" />
        <input type="text" id="addFieldProperty" placeholder="Property Name in NHTSA JSON" />
        <button id="addFieldBtn">Add Field</button>
      </div>

      <div class="modal-actions">
        <button id="saveCustomFieldsBtn">Save</button>
        <button id="resetDefaultFieldsBtn">Restore Default Fields</button>
      </div>
    </div>
  </div>

  <script>
    // ---------------------------------------------------------------------
    // 1) MASTER LIST OF KNOWN FIELDS (demo subset).
    // ---------------------------------------------------------------------
   <script>
// ---------------------------------------------------------------------
// 1) MASTER LIST OF ALL NHTSA FIELDS (140 total).
// ---------------------------------------------------------------------
const masterFieldsList = [
  { numericId: 1,   label: "Other Battery Info",                                      propertyName: "OtherBatteryInfo", enabled: false },
  { numericId: 2,   label: "Battery Type",                                            propertyName: "BatteryType", enabled: false },
  { numericId: 3,   label: "Bed Type",                                                propertyName: "BedType", enabled: false },
  { numericId: 4,   label: "Cab Type",                                                propertyName: "CabType", enabled: false },
  { numericId: 5,   label: "Body Class",                                              propertyName: "BodyClass", enabled: false },
  { numericId: 9,   label: "Engine Number of Cylinders",                              propertyName: "EngineNumberOfCylinders", enabled: false },
  { numericId: 10,  label: "Destination Market",                                      propertyName: "DestinationMarket", enabled: false },
  { numericId: 11,  label: "Displacement (CC)",                                       propertyName: "DisplacementCC", enabled: false },
  { numericId: 12,  label: "Displacement (CI)",                                       propertyName: "DisplacementCI", enabled: false },
  { numericId: 13,  label: "Displacement (L)",                                        propertyName: "DisplacementL", enabled: false },
  { numericId: 14,  label: "Doors",                                                   propertyName: "Doors", enabled: false },
  { numericId: 15,  label: "Drive Type",                                              propertyName: "DriveType", enabled: false },
  { numericId: 17,  label: "Engine Stroke Cycles",                                    propertyName: "EngineStrokeCycles", enabled: false },
  { numericId: 18,  label: "Engine Model",                                            propertyName: "EngineModel", enabled: false },
  { numericId: 21,  label: "Engine Power (kW)",                                       propertyName: "EnginePowerKW", enabled: false },
  { numericId: 23,  label: "Entertainment System",                                    propertyName: "EntertainmentSystem", enabled: false },
  { numericId: 24,  label: "Fuel Type - Primary",                                     propertyName: "FuelTypePrimary", enabled: false },
  { numericId: 25,  label: "Gross Vehicle Weight Rating From",                        propertyName: "GrossVehicleWeightRatingFrom", enabled: false },
  { numericId: 26,  label: "Make",                                                    propertyName: "Make", enabled: false },
  { numericId: 27,  label: "Manufacturer Name",                                       propertyName: "ManufacturerName", enabled: false },
  { numericId: 28,  label: "Model",                                                   propertyName: "Model", enabled: false },
  { numericId: 29,  label: "Model Year",                                              propertyName: "ModelYear", enabled: false },
  { numericId: 31,  label: "Plant City",                                              propertyName: "PlantCity", enabled: false },
  { numericId: 33,  label: "Number of Seats",                                         propertyName: "NumberOfSeats", enabled: false },
  { numericId: 34,  label: "Series",                                                  propertyName: "Series", enabled: false },
  { numericId: 36,  label: "Steering Location",                                       propertyName: "SteeringLocation", enabled: false },
  { numericId: 37,  label: "Transmission Style",                                      propertyName: "TransmissionStyle", enabled: false },
  { numericId: 38,  label: "Trim",                                                    propertyName: "Trim", enabled: false },
  { numericId: 39,  label: "Vehicle Type",                                            propertyName: "VehicleType", enabled: false },
  { numericId: 40,  label: "Windows",                                                 propertyName: "Windows", enabled: false },
  { numericId: 41,  label: "Axles",                                                   propertyName: "Axles", enabled: false },
  { numericId: 42,  label: "Brake System Type",                                       propertyName: "BrakeSystemType", enabled: false },
  { numericId: 48,  label: "Number of Battery Cells per Module",                      propertyName: "NumberOfBatteryCellsPerModule", enabled: false },
  { numericId: 49,  label: "Bed Length (inches)",                                     propertyName: "BedLengthInches", enabled: false },
  { numericId: 52,  label: "Brake System Description",                                propertyName: "BrakeSystemDescription", enabled: false },
  { numericId: 54,  label: "Curb Weight (pounds)",                                    propertyName: "CurbWeightPounds", enabled: false },
  { numericId: 55,  label: "Curtain Air Bag Locations",                               propertyName: "CurtainAirBagLocations", enabled: false },
  { numericId: 56,  label: "Seat Cushion Air Bag Locations",                          propertyName: "SeatCushionAirBagLocations", enabled: false },
  { numericId: 57,  label: "Battery Current (Amps) From",                             propertyName: "BatteryCurrentAmpsFrom", enabled: false },
  { numericId: 58,  label: "Battery Voltage (Volts) From",                            propertyName: "BatteryVoltageVoltsFrom", enabled: false },
  { numericId: 59,  label: "Battery Energy (kWh) From",                               propertyName: "BatteryEnergykWhFrom", enabled: false },
  { numericId: 60,  label: "Wheel Base Type",                                         propertyName: "WheelBaseType", enabled: false },
  { numericId: 61,  label: "Number of Seat Rows",                                     propertyName: "NumberOfSeatRows", enabled: false },
  { numericId: 62,  label: "Valve Train Design",                                      propertyName: "ValveTrainDesign", enabled: false },
  { numericId: 63,  label: "Transmission Speeds",                                     propertyName: "TransmissionSpeeds", enabled: false },
  { numericId: 64,  label: "Engine Configuration",                                    propertyName: "EngineConfiguration", enabled: false },
  { numericId: 65,  label: "Front Air Bag Locations",                                 propertyName: "FrontAirBagLocations", enabled: false },
  { numericId: 66,  label: "Fuel Type - Secondary",                                   propertyName: "FuelTypeSecondary", enabled: false },
  { numericId: 67,  label: "Fuel Delivery / Fuel Injection Type",                     propertyName: "FuelDeliveryFuelInjectionType", enabled: false },
  { numericId: 69,  label: "Knee Air Bag Locations",                                  propertyName: "KneeAirBagLocations", enabled: false },
  { numericId: 71,  label: "Engine Brake (hp) From",                                  propertyName: "EngineBrakeHPFrom", enabled: false },
  { numericId: 72,  label: "EV Drive Unit",                                           propertyName: "EVDriveUnit", enabled: false },
  { numericId: 75,  label: "Plant Country",                                           propertyName: "PlantCountry", enabled: false },
  { numericId: 76,  label: "Plant Company Name",                                      propertyName: "PlantCompanyName", enabled: false },
  { numericId: 77,  label: "Plant State",                                             propertyName: "PlantState", enabled: false },
  { numericId: 78,  label: "Pretensioner",                                            propertyName: "Pretensioner", enabled: false },
  { numericId: 79,  label: "Seat Belt Type",                                          propertyName: "SeatBeltType", enabled: false },
  { numericId: 81,  label: "Adaptive Cruise Control (ACC)",                           propertyName: "AdaptiveCruiseControlACC", enabled: false },
  { numericId: 86,  label: "Anti-lock Braking System (ABS)",                          propertyName: "AntiLockBrakingSystemABS", enabled: false },
  { numericId: 87,  label: "Crash Imminent Braking (CIB)",                            propertyName: "CrashImminentBrakingCIB", enabled: false },
  { numericId: 88,  label: "Blind Spot Warning (BSW)",                                propertyName: "BlindSpotWarningBSW", enabled: false },
  { numericId: 96,  label: "NCSA Body Type",                                          propertyName: "NCSABodyType", enabled: false },
  { numericId: 97,  label: "NCSA Make",                                               propertyName: "NCSAMake", enabled: false },
  { numericId: 98,  label: "NCSA Model",                                              propertyName: "NCSAModel", enabled: false },
  { numericId: 99,  label: "Electronic Stability Control (ESC)",                      propertyName: "ElectronicStabilityControlESC", enabled: false },
  { numericId: 100, label: "Traction Control",                                        propertyName: "TractionControl", enabled: false },
  { numericId: 101, label: "Forward Collision Warning (FCW)",                         propertyName: "ForwardCollisionWarningFCW", enabled: false },
  { numericId: 102, label: "Lane Departure Warning (LDW)",                            propertyName: "LaneDepartureWarningLDW", enabled: false },
  { numericId: 103, label: "Lane Keeping Assistance (LKA)",                           propertyName: "LaneKeepingAssistanceLKA", enabled: false },
  { numericId: 104, label: "Backup Camera",                                           propertyName: "BackupCamera", enabled: false },
  { numericId: 105, label: "Parking Assist",                                          propertyName: "ParkingAssist", enabled: false },
  { numericId: 107, label: "Side Air Bag Locations",                                  propertyName: "SideAirBagLocations", enabled: false },
  { numericId: 109, label: "Trim2",                                                   propertyName: "Trim2", enabled: false },
  { numericId: 110, label: "Series2",                                                 propertyName: "Series2", enabled: false },
  { numericId: 111, label: "Wheel Base (inches) From",                                propertyName: "WheelBaseInchesFrom", enabled: false },
  { numericId: 112, label: "Wheel Base (inches) To",                                  propertyName: "WheelBaseInchesTo", enabled: false },
  { numericId: 114, label: "Note",                                                    propertyName: "Note", enabled: false },
  { numericId: 115, label: "Number of Wheels",                                        propertyName: "NumberOfWheels", enabled: false },
  { numericId: 116, label: "Trailer Type Connection",                                 propertyName: "TrailerTypeConnection", enabled: false },
  { numericId: 117, label: "Trailer Body Type",                                       propertyName: "TrailerBodyType", enabled: false },
  { numericId: 118, label: "Trailer Length (feet)",                                   propertyName: "TrailerLengthFeet", enabled: false },
  { numericId: 119, label: "Wheel Size Front (inches)",                               propertyName: "WheelSizeFrontInches", enabled: false },
  { numericId: 120, label: "Wheel Size Rear (inches)",                                propertyName: "WheelSizeRearInches", enabled: false },
  { numericId: 121, label: "Other Restraint System Info",                             propertyName: "OtherRestraintSystemInfo", enabled: false },
  { numericId: 122, label: "Cooling Type",                                            propertyName: "CoolingType", enabled: false },
  { numericId: 125, label: "Engine Brake (hp) To",                                    propertyName: "EngineBrakeHPTo", enabled: false },
  { numericId: 126, label: "Electrification Level",                                   propertyName: "ElectrificationLevel", enabled: false },
  { numericId: 127, label: "Charger Level",                                           propertyName: "ChargerLevel", enabled: false },
  { numericId: 128, label: "Charger Power (kW)",                                      propertyName: "ChargerPowerkW", enabled: false },
  { numericId: 129, label: "Other Engine Info",                                       propertyName: "OtherEngineInfo", enabled: false },
  { numericId: 132, label: "Battery Current (Amps) To",                               propertyName: "BatteryCurrentAmpsTo", enabled: false },
  { numericId: 133, label: "Battery Voltage (Volts) To",                              propertyName: "BatteryVoltageVoltsTo", enabled: false },
  { numericId: 134, label: "Battery Energy (kWh) To",                                 propertyName: "BatteryEnergykWhTo", enabled: false },
  { numericId: 135, label: "Turbo",                                                   propertyName: "Turbo", enabled: false },
  { numericId: 136, label: "Base Price ($)",                                          propertyName: "BasePrice", enabled: false },
  { numericId: 137, label: "Number of Battery Modules per Pack",                      propertyName: "NumberOfBatteryModulesPerPack", enabled: false },
  { numericId: 138, label: "Number of Battery Packs per Vehicle",                     propertyName: "NumberOfBatteryPacksPerVehicle", enabled: false },
  { numericId: 139, label: "Top Speed (MPH)",                                         propertyName: "TopSpeedMPH", enabled: false },
  { numericId: 142, label: "Suggested VIN",                                           propertyName: "SuggestedVIN", enabled: false },
  { numericId: 143, label: "Error Code",                                              propertyName: "ErrorCode", enabled: false },
  { numericId: 144, label: "Possible Values",                                         propertyName: "PossibleValues", enabled: false },
  { numericId: 145, label: "Axle Configuration",                                      propertyName: "AxleConfiguration", enabled: false },
  { numericId: 146, label: "Engine Manufacturer",                                     propertyName: "EngineManufacturer", enabled: false },
  { numericId: 147, label: "Bus Length (feet)",                                       propertyName: "BusLengthFeet", enabled: false },
  { numericId: 148, label: "Bus Floor Configuration Type",                            propertyName: "BusFloorConfigurationType", enabled: false },
  { numericId: 149, label: "Bus Type",                                                propertyName: "BusType", enabled: false },
  { numericId: 150, label: "Other Bus Info",                                          propertyName: "OtherBusInfo", enabled: false },
  { numericId: 151, label: "Custom Motorcycle Type",                                  propertyName: "CustomMotorcycleType", enabled: false },
  { numericId: 152, label: "Motorcycle Suspension Type",                              propertyName: "MotorcycleSuspensionType", enabled: false },
  { numericId: 153, label: "Motorcycle Chassis Type",                                 propertyName: "MotorcycleChassisType", enabled: false },
  { numericId: 154, label: "Other Motorcycle Info",                                   propertyName: "OtherMotorcycleInfo", enabled: false },
  { numericId: 155, label: "Other Trailer Info",                                      propertyName: "OtherTrailerInfo", enabled: false },
  { numericId: 156, label: "Additional Error Text",                                   propertyName: "AdditionalErrorText", enabled: false },
  { numericId: 159, label: "Track Width (inches)",                                    propertyName: "TrackWidthInches", enabled: false },
  { numericId: 168, label: "Tire Pressure Monitoring System (TPMS) Type",             propertyName: "TirePressureMonitoringSystemTPMSType", enabled: false },
  { numericId: 169, label: "Active Safety System Note",                               propertyName: "ActiveSafetySystemNote", enabled: false },
  { numericId: 170, label: "Dynamic Brake Support (DBS)",                             propertyName: "DynamicBrakeSupportDBS", enabled: false },
  { numericId: 171, label: "Pedestrian Automatic Emergency Braking (PAEB)",          propertyName: "PedestrianAutomaticEmergencyBrakingPAEB", enabled: false },
  { numericId: 172, label: "Auto-Reverse System for Windows and Sunroofs",            propertyName: "AutoReverseSystemForWindowsAndSunroofs", enabled: false },
  { numericId: 173, label: "Automatic Pedestrian Alerting Sound (for Hybrid and EV only)",  propertyName: "AutomaticPedestrianAlertingSoundForHybridAndEVOnly", enabled: false },
  { numericId: 174, label: "Automatic Crash Notification (ACN) / Advanced Automatic Crash Notification (AACN)", propertyName: "AutomaticCrashNotificationACNAdvancedAutomaticCrashNotificationAACN", enabled: false },
  { numericId: 175, label: "Event Data Recorder (EDR)",                               propertyName: "EventDataRecorderEDR", enabled: false },
  { numericId: 176, label: "Keyless Ignition",                                        propertyName: "KeylessIgnition", enabled: false },
  { numericId: 177, label: "Daytime Running Light (DRL)",                             propertyName: "DaytimeRunningLightDRL", enabled: false },
  { numericId: 178, label: "Headlamp Light Source",                                   propertyName: "HeadlampLightSource", enabled: false },
  { numericId: 179, label: "Semiautomatic Headlamp Beam Switching",                   propertyName: "SemiautomaticHeadlampBeamSwitching", enabled: false },
  { numericId: 180, label: "Adaptive Driving Beam (ADB)",                             propertyName: "AdaptiveDrivingBeamADB", enabled: false },
  { numericId: 181, label: "SAE Automation Level From",                               propertyName: "SAEAutomationLevelFrom", enabled: false },
  { numericId: 182, label: "SAE Automation Level To",                                 propertyName: "SAEAutomationLevelTo", enabled: false },
  { numericId: 183, label: "Rear Cross Traffic Alert",                                propertyName: "RearCrossTrafficAlert", enabled: false },
  { numericId: 184, label: "Gross Combination Weight Rating From",                    propertyName: "GrossCombinationWeightRatingFrom", enabled: false },
  { numericId: 185, label: "Gross Combination Weight Rating To",                      propertyName: "GrossCombinationWeightRatingTo", enabled: false },
  { numericId: 186, label: "NCSA Note",                                               propertyName: "NCSANote", enabled: false },
  { numericId: 190, label: "Gross Vehicle Weight Rating To",                          propertyName: "GrossVehicleWeightRatingTo", enabled: false },
  { numericId: 191, label: "Error Text",                                              propertyName: "ErrorText", enabled: false },
  { numericId: 192, label: "Rear Automatic Emergency Braking",                        propertyName: "RearAutomaticEmergencyBraking", enabled: false },
  { numericId: 193, label: "Blind Spot Intervention (BSI)",                           propertyName: "BlindSpotInterventionBSI", enabled: false },
  { numericId: 194, label: "Lane Centering Assistance",                               propertyName: "LaneCenteringAssistance", enabled: false },
  { numericId: 195, label: "Non-Land Use",                                            propertyName: "NonLandUse", enabled: false },
  { numericId: 196, label: "Vehicle Descriptor",                                      propertyName: "VehicleDescriptor", enabled: false }
];

// The rest of your code stays the same, except for replacing your old masterFieldsList
// with this new one. Keep your DEFAULT_ENABLED_IDS array and everything else in place.



    // IDs that should be enabled by default (first load)
    const DEFAULT_ENABLED_IDS = [29, 26, 28, 64, 9, 13, 126, 24, 66, 135, 71, 125, 129, 18, 62, 67, 122, 139, 146, 114, 2, 1, 21, 48, 57, 58, 59, 72, 127, 128, 132, 133, 134, 137, 138, 37, 63, 15, 119, 120, 196, 39, 5, 14, 33, 34, 38, 109, 110, 60, 61, 96, 97, 98, 186, 4, 3, 49, 54, 25, 190, 111, 112, 159, 184, 185]; // e.g., Model Year, Make, Model

    // Current config of fields (loaded from localStorage or from master list)
    let currentFieldsList = [];

    // Elements
    const vinInput = document.getElementById('vinInput');
    const decodeBtn = document.getElementById('decodeBtn');
    const clearBtn = document.getElementById('clearBtn');
    const resultsContainer = document.getElementById('resultsContainer');
    const customizeBtn = document.getElementById('customizeBtn');
    const modalOverlay = document.getElementById('modalOverlay');
    const closeModalBtn = document.getElementById('closeModalBtn');
    const checkedFieldsListEl = document.getElementById('checkedFieldsList');
    const uncheckedFieldsListEl = document.getElementById('uncheckedFieldsList');
    const saveCustomFieldsBtn = document.getElementById('saveCustomFieldsBtn');
    const resetDefaultFieldsBtn = document.getElementById('resetDefaultFieldsBtn');
    const addFieldId = document.getElementById('addFieldId');
    const addFieldLabel = document.getElementById('addFieldLabel');
    const addFieldProperty = document.getElementById('addFieldProperty');
    const addFieldBtn = document.getElementById('addFieldBtn');
    const copyAllContainer = document.getElementById('copyAllContainer');

    // --------------------------------------------
    // 2) LOAD/SAVE FIELD CONFIG FROM LOCALSTORAGE
    // --------------------------------------------
    function loadFieldConfig() {
      const saved = localStorage.getItem('vinDecoderFields');
      if (saved) {
        currentFieldsList = JSON.parse(saved);
      } else {
        // No saved config; copy from master, enabling certain defaults
        currentFieldsList = masterFieldsList.map(field => ({
          ...field,
          enabled: DEFAULT_ENABLED_IDS.includes(field.numericId)
        }));
      }
    }
    function saveFieldConfig() {
      localStorage.setItem('vinDecoderFields', JSON.stringify(currentFieldsList));
    }
    loadFieldConfig(); // initialize

    // ------------------------------------------------------
    // 3) SHOW/HIDE MODAL
    // ------------------------------------------------------
    function openModal() {
      buildFieldLists();
      modalOverlay.style.display = 'flex';
    }
    function closeModal() {
      modalOverlay.style.display = 'none';
    }
    customizeBtn.addEventListener('click', openModal);
    closeModalBtn.addEventListener('click', () => {
      // If user cancels, reload from storage to discard changes
      loadFieldConfig();
      closeModal();
    });

    // ------------------------------------------------------
    // 4) BUILD THE CHECKED/UNCHECKED FIELD LISTS (DRAG & DROP)
    // ------------------------------------------------------
    function buildFieldLists() {
      // Separate fields into checked and unchecked arrays
      const checked = currentFieldsList.filter(f => f.enabled);
      const unchecked = currentFieldsList.filter(f => !f.enabled);

      // Clear the UI
      checkedFieldsListEl.innerHTML = '';
      uncheckedFieldsListEl.innerHTML = '';

      // Build the UI for each group
      buildDragList(checked, checkedFieldsListEl, true);
      buildDragList(unchecked, uncheckedFieldsListEl, false);
    }

    // Helper to build a drag&drop list for a given array of fields
    function buildDragList(fieldsArray, containerEl, isCheckedGroup) {
      fieldsArray.forEach((field, index) => {
        const li = document.createElement('li');
        li.className = 'field-list-item';
        li.draggable = true;
        li.dataset.index = index.toString();
        li.dataset.isChecked = isCheckedGroup ? 'true' : 'false';

        // Drag events
        li.addEventListener('dragstart', onDragStart);
        li.addEventListener('dragover', onDragOver);
        li.addEventListener('drop', onDrop);
        li.addEventListener('dragend', onDragEnd);

        // Checkbox
        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.checked = isCheckedGroup;
        checkbox.addEventListener('change', () => {
          field.enabled = checkbox.checked;
          // Rebuild the lists so the field moves to other group
          buildFieldLists();
        });

        // Label
        const labelSpan = document.createElement('span');
        labelSpan.className = 'field-label';
        labelSpan.textContent = `${field.label} (${field.numericId || 'N/A'})`;

        li.appendChild(checkbox);
        li.appendChild(labelSpan);
        containerEl.appendChild(li);
      });
    }

    // Drag & Drop Implementation
    let dragSrcEl = null;
    let dragSrcIndex = null;
    let dragSrcIsChecked = null;

    function onDragStart(e) {
      dragSrcEl = this;
      dragSrcIndex = parseInt(this.dataset.index, 10);
      dragSrcIsChecked = (this.dataset.isChecked === 'true');
      e.dataTransfer.effectAllowed = 'move';
      e.dataTransfer.setData('text/html', this.innerHTML);
    }
    function onDragOver(e) {
      e.preventDefault();
      this.classList.add('drag-over');
      e.dataTransfer.dropEffect = 'move';
    }
    function onDragEnd() {
      const items = document.querySelectorAll('.field-list-item');
      items.forEach(i => i.classList.remove('drag-over'));
    }
    function onDrop(e) {
      e.stopPropagation();
      const dropTarget = this;
      dropTarget.classList.remove('drag-over');
      if (dragSrcEl === dropTarget) {
        return;
      }
      const dropIndex = parseInt(dropTarget.dataset.index, 10);
      const dropIsChecked = (dropTarget.dataset.isChecked === 'true');

      const checkedArray = currentFieldsList.filter(f => f.enabled);
      const uncheckedArray = currentFieldsList.filter(f => !f.enabled);

      // Remove dragged item from its array
      let item;
      if (dragSrcIsChecked) {
        item = checkedArray.splice(dragSrcIndex, 1)[0];
      } else {
        item = uncheckedArray.splice(dragSrcIndex, 1)[0];
      }

      // If same group, reorder
      if (dragSrcIsChecked === dropIsChecked) {
        if (dropIsChecked) {
          checkedArray.splice(dropIndex, 0, item);
        } else {
          uncheckedArray.splice(dropIndex, 0, item);
        }
      } else {
        // cross-group drag not allowed; revert
        if (dragSrcIsChecked) {
          checkedArray.splice(dragSrcIndex, 0, item);
        } else {
          uncheckedArray.splice(dragSrcIndex, 0, item);
        }
      }

      // Rebuild currentFieldsList
      currentFieldsList = [...checkedArray, ...uncheckedArray];
      buildFieldLists();
    }

    // -----------------------------------------------------------
    // 5) ADD NEW FIELD
    // -----------------------------------------------------------
    addFieldBtn.addEventListener('click', () => {
      const numId = parseInt(addFieldId.value.trim(), 10) || null;
      const label = addFieldLabel.value.trim();
      const prop = addFieldProperty.value.trim();

      if (!label || !prop) {
        alert('Please provide at least a Label and a Property Name.');
        return;
      }

      const newField = {
        numericId: numId,
        label,
        propertyName: prop,
        enabled: true // new fields default to enabled
      };

      currentFieldsList.push(newField);
      buildFieldLists();

      // Clear form
      addFieldId.value = '';
      addFieldLabel.value = '';
      addFieldProperty.value = '';
    });

    // -----------------------------------------------------------
    // 6) SAVE OR RESET DEFAULT FIELDS
    // -----------------------------------------------------------
    saveCustomFieldsBtn.addEventListener('click', () => {
      // Save changes
      saveFieldConfig();
      closeModal();
    });

    resetDefaultFieldsBtn.addEventListener('click', () => {
      // Re-derive from master list with default IDs
      currentFieldsList = masterFieldsList.map(field => ({
        ...field,
        enabled: DEFAULT_ENABLED_IDS.includes(field.numericId)
      }));
      buildFieldLists();
    });

    // -----------------------------------------------------------
    // 7) DECODING LOGIC + "COPY ALL" BUTTON
    // -----------------------------------------------------------
    decodeBtn.addEventListener('click', async () => {
      const vinList = vinInput.value
        .split(/\n/g)
        .map(v => v.trim())
        .filter(v => v !== '');
      
      if (!vinList.length) {
        alert('No VINs entered!');
        return;
      }

      // Clear old results
      resultsContainer.innerHTML = '';
      copyAllContainer.innerHTML = '';

      const batchString = vinList.join(';');

      try {
        const response = await fetch('https://vpic.nhtsa.dot.gov/api/vehicles/DecodeVINValuesBatch/', {
          method: 'POST',
          headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
          body: new URLSearchParams({
            format: 'json',
            data: batchString
          })
        });
        
        const data = await response.json();
        const results = data.Results || [];

        if (results.length > 0) {
          // "Copy ALL" button at the top
          const copyAllBtn = document.createElement('button');
          copyAllBtn.textContent = 'Copy ALL VIN Data';
          copyAllBtn.addEventListener('click', () => {
            const lines = results.map(item => getRowData(item));
            const finalString = lines.join('\n');
            navigator.clipboard.writeText(finalString)
              .then(() => alert('Copied all VIN data to clipboard!'))
              .catch(() => alert('Unable to copy.'));
          });
          copyAllContainer.appendChild(copyAllBtn);
        }

        // Build each VIN result block
        results.forEach((decodedItem, idx) => {
          const vinDiv = document.createElement('div');
          vinDiv.className = 'vin-block';
          
          const vinHeader = document.createElement('h3');
          vinHeader.innerText = `#${idx + 1} VIN: ${decodedItem.VIN || 'null'}`;
          vinDiv.appendChild(vinHeader);

          // "Copy This VIN" button
          const copyBtn = document.createElement('button');
          copyBtn.innerText = 'Copy This VIN Data';
          copyBtn.style.marginBottom = '8px';
          copyBtn.addEventListener('click', () => {
            const rowData = getRowData(decodedItem);
            navigator.clipboard.writeText(rowData)
              .then(() => alert(`Copied data for VIN: ${decodedItem.VIN}`))
              .catch(() => alert('Unable to copy.'));
          });
          vinDiv.appendChild(copyBtn);

          // List of field values
          const dataList = document.createElement('ul');

          // Only iterate enabled fields, in the current order
          const enabledFields = currentFieldsList.filter(f => f.enabled);
          enabledFields.forEach(f => {
            const li = document.createElement('li');
            // If field is blank, display "null"
            const value = decodedItem[f.propertyName] || 'null';
            li.textContent = `${f.label}: ${value}`;
            dataList.appendChild(li);
          });
          
          vinDiv.appendChild(dataList);
          resultsContainer.appendChild(vinDiv);
        });

      } catch (err) {
        console.error(err);
        alert('Error decoding VINs. See console for details.');
      }
    });

    // Return a single tab-separated line for one VIN’s data
    function getRowData(decodedItem) {
      const enabledFields = currentFieldsList.filter(f => f.enabled);
      const values = enabledFields.map(f => {
        // If the API value is blank, use 'null'
        return decodedItem[f.propertyName] || 'null';
      });
      return values.join('\t');
    }

    // Clear / Reset
    clearBtn.addEventListener('click', () => {
      vinInput.value = '';
      resultsContainer.innerHTML = '';
      copyAllContainer.innerHTML = '';
    });
  </script>
</body>
</html>
